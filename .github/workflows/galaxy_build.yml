name: Publish Ansible Galaxy Collection

on:
  push:
    branches:
      - main  # Ã„ndern Sie dies entsprechend Ihrem Hauptbranch

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install ansible[galaxy]
          
      - name: Update version in collection.yml
        run: |
              GALAXY_YML_PATH="./galaxy.yml"
              extracted_version=$(GALAXY_YML_PATH.yml | sed -n 's/^.*version: "\(.*\)"/\1/p')
              current_version=$(grep '^version:' $GALAXY_YML_PATH | cut -d'"' -f2)
              echo old version: $current_version

              IFS='.' read -ra parts <<< "$current_version"
              for (( i=0; i<${#parts[@]}; i++ )); do
                  if (( parts[i] > 99 )); then
                      parts[i]=0
                      if (( i < ${#parts[@]} - 1 )); then
                          let parts[i+1]=${parts[i+1]}+1
                      fi
                  else
                      let parts[i]=${parts[i]}+1
                  fi
              done

              updated_version="${parts[*]}"
              echo new version: $updated_version
              IFS='.' read -ra updated_parts <<< "$updated_version"

              updated_parts=( $(printf "%s\n" "${updated_parts[@]}" | sort -n) )

              updated_version="${updated_parts[*]}"

              sed -i "s/^version:.*/version: \"$updated_version\"/" $GALAXY_YML_PATH

        
      - name: Build collection
        run: ansible-galaxy collection build -vvv --output-path . --requirements-file requirements.txt --force
        env:
          ANSIBLE_GALAXY_API_KEY: ${{ secrets.GALAXY_API_KEY }}  # Stellen Sie sicher, dass GALAXY_API_KEY in Ihren Secrets gesetzt ist

      - name: Publish collection
        run: ansible-galaxy collection publish --api-key ${{ secrets.GALAXY_API_KEY }} ./ji_podhead-ilohelper-*.tar.gz
        env:
          ANSIBLE_GALAXY_API_KEY: ${{ secrets.GALAXY_API_KEY }}
